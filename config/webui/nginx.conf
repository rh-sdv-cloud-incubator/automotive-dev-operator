events {
  worker_connections 1024;
}

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  sendfile on;
  keepalive_timeout 65;
  access_log /dev/stdout;
  error_log /dev/stderr notice;

  server {
    listen 8080;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # Ensure the HTML shell is never cached so redeploys take effect without hard refresh
    location = /index.html {
      add_header Cache-Control "no-cache, no-store, must-revalidate" always;
      add_header Pragma "no-cache" always;
      add_header Expires "0" always;
    }

    location / {
      try_files $uri $uri/ /index.html;
    }

    # Proxy OAuth requests to the OAuth proxy
    location /oauth/ {
      proxy_pass http://127.0.0.1:8081;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $server_name;
    }

    # serve runtime config
    location = /config.js {
      default_type application/javascript;
      add_header Cache-Control "no-cache, no-store, must-revalidate" always;
      add_header Pragma "no-cache" always;
      add_header Expires "0" always;
      return 200 "window.__API_BASE = '';\n";
    }

    location ~ ^/v1/builds/.*/logs/sse$ {
      proxy_pass http://ado-build-api:8080;
      proxy_set_header Authorization "Bearer $http_x_forwarded_access_token";
      proxy_set_header X-Forwarded-Access-Token $http_x_forwarded_access_token;
      proxy_set_header X-Forwarded-User $http_x_forwarded_user;
      proxy_set_header X-Forwarded-Email $http_x_forwarded_email;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # SSE-specific settings
      proxy_buffering off;
      proxy_cache off;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      chunked_transfer_encoding off;
      proxy_read_timeout 86400s;
      proxy_send_timeout 86400s;
      proxy_connect_timeout 10s;
    }

    location /v1/builds/sse {
      proxy_pass http://ado-build-api:8080;
      proxy_set_header Authorization "Bearer $http_x_forwarded_access_token";
      proxy_set_header X-Forwarded-Access-Token $http_x_forwarded_access_token;
      proxy_set_header X-Forwarded-User $http_x_forwarded_user;
      proxy_set_header X-Forwarded-Email $http_x_forwarded_email;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_buffering off;
      proxy_cache off;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      chunked_transfer_encoding off;
      proxy_read_timeout 86400s;
      proxy_send_timeout 86400s;
      proxy_connect_timeout 10s;
    }

    location /v1/ {
      # Send API calls directly to build-api upstream (8080), not its oauth-proxy
      proxy_pass http://ado-build-api:8080;
      proxy_set_header Authorization "Bearer $http_x_forwarded_access_token";
      proxy_set_header X-Forwarded-Access-Token $http_x_forwarded_access_token;
      proxy_set_header X-Forwarded-User $http_x_forwarded_user;
      proxy_set_header X-Forwarded-Email $http_x_forwarded_email;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_buffering off;
      proxy_cache off;
      proxy_read_timeout 1800s;  # 30 minutes for large artifact downloads
      proxy_send_timeout 1800s;  # 30 minutes for uploads
      proxy_connect_timeout 60s; # Connection timeout
    }

    # Long-cache static assets; HTML remains no-cache
    location ~* \.(?:js|css|png|jpg|jpeg|gif|svg|ico|woff2?)$ {
      add_header Cache-Control "public, max-age=31536000, immutable" always;
      expires 1y;
    }

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  }
}
